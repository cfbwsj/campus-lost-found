# 🚀 Docker完整启动说明（保留所有功能）

## ⏱️ 预计构建时间

**首次构建总时间：约30-40分钟**

| 步骤 | 时间 | 说明 |
|------|------|------|
| 拉取基础镜像 | 5分钟 | Python、Node、PostgreSQL等 |
| 安装系统依赖 | 5分钟 | Tesseract OCR等 |
| **安装PyTorch** | **15-20分钟** | 最耗时（670MB + CUDA库） |
| 安装其他Python包 | 3-5分钟 | FastAPI、SQLAlchemy等 |
| 构建前端 | 2-3分钟 | React编译 |
| 启动服务 | 1分钟 | 所有容器启动 |

**后续启动时间：约1分钟**（使用缓存）

---

## 🎯 启动步骤

### 方法1：使用批处理文件（推荐）

**双击运行：**
```
D:\AIweb\campus-lost-found\启动Docker.bat
```

**然后等待30-40分钟。**

---

### 方法2：命令行启动

```powershell
cd D:\AIweb\campus-lost-found
docker-compose up -d --build
```

---

## 📊 构建过程说明

### 阶段1：拉取镜像（约5分钟）
```
✓ postgres:13-alpine
✓ elasticsearch:7.17.0
✓ redis:6-alpine
✓ python:3.9-slim
✓ node:18-alpine
✓ nginx:alpine
```

### 阶段2：构建后端（约25-30分钟）
```
[1/7] 安装系统依赖（Tesseract OCR）...       约5分钟
[2/7] 安装FastAPI、SQLAlchemy...              约2分钟
[3/7] 安装PyTorch（670MB）...                约10分钟
[4/7] 安装CUDA库（nvidia-cudnn等，700MB+）... 约15分钟
[5/7] 安装transformers、opencv等...           约3分钟
```

**关键提示：**
- PyTorch和CUDA库下载很大（~1.5GB）
- 如果网络慢，可能需要更长时间
- **不要中断构建过程！**

### 阶段3：构建前端（约2-3分钟）
```
[1/7] npm install...  约1分钟
[2/7] npm run build... 约2分钟
```

### 阶段4：启动服务（约1分钟）
```
✓ campus-postgres
✓ campus-elasticsearch
✓ campus-redis
✓ campus-backend
✓ campus-frontend
```

---

## 🌐 启动后访问

**访问地址：**
- 前端：http://localhost:3000
- 后端API：http://localhost:8000/docs
- PostgreSQL：localhost:5432
- ElasticSearch：http://localhost:9200
- Redis：localhost:6379

---

## ✅ 完整功能清单

所有功能都保留，没有任何简化：

| 功能 | 状态 | 依赖 |
|------|------|------|
| PostgreSQL数据库 | ✅ | postgres:13-alpine |
| ElasticSearch搜索 | ✅ | elasticsearch:7.17.0 |
| Redis缓存 | ✅ | redis:6-alpine |
| Tesseract OCR | ✅ | pytesseract + opencv |
| AI物品分类 | ✅ | PyTorch + torchvision |
| Transformers模型 | ✅ | transformers库 |
| 图片上传 | ✅ | python-multipart |
| FastAPI后端 | ✅ | uvicorn |
| React前端 | ✅ | React 18 + Ant Design |

---

## 📝 构建进度查看

### 查看实时日志
```bash
docker-compose logs -f backend
```

### 查看构建进度
```bash
docker-compose build --progress=plain backend
```

---

## ⚠️ 常见问题

### Q1: 构建很慢/卡住了？

**原因：** PyTorch和CUDA库很大（~1.5GB）

**解决：**
- 耐心等待，不要中断
- 确保网络稳定
- 可以开着让它慢慢下载

### Q2: 内存不足？

**推荐配置：**
- Docker内存：至少8GB
- 系统空闲内存：至少4GB
- 硬盘空间：至少10GB

**检查Docker内存：**
- 打开Docker Desktop
- Settings → Resources → Memory
- 建议设置为8GB或更多

### Q3: hash值不匹配？

这是清华镜像的包和官方源不一致导致的。

**已自动处理：**
- 先尝试使用清华镜像（快）
- 如果失败，自动回退到官方源（慢但稳定）

---

## 🔧 Docker内存设置

### 查看当前设置
```bash
docker info | findstr Memory
```

### 修改内存限制
1. 打开Docker Desktop
2. 设置 → Resources → Memory
3. 拉到至少8GB
4. 点击"Apply & Restart"

---

## 📂 数据存储位置

| 类型 | 位置 |
|------|------|
| 项目代码 | D:\AIweb\campus-lost-found |
| 上传文件 | D:\AIweb\campus-lost-found\backend\uploads |
| PostgreSQL数据 | Docker卷（可配置） |
| ElasticSearch数据 | Docker卷（可配置） |
| Redis数据 | Docker卷（可配置） |

---

## 💡 优化建议

### 首次构建慢是正常的

**原因：**
- PyTorch: 670MB
- CUDA库: 700+MB
- 其他依赖: 200+MB
- **总计下载量: ~1.5GB**

**后续启动快：**
- Docker会缓存所有层
- 只要代码不变，不需要重新构建
- 启动时间: ~1分钟

---

## 🎯 成功标志

**当你看到这个，说明成功了：**
```
✅ 所有服务已启动！

📊 服务地址：
  前端：http://localhost:3000
  后端：http://localhost:8000
  API文档：http://localhost:8000/docs
```

**然后访问 http://localhost:3000 测试！**

---

**现在开始构建，预计30-40分钟完成！** ☕

建议：
1. 启动构建
2. 去休息一下
3. 30分钟后回来查看
4. 成功后访问 http://localhost:3000

**祝使用愉快！** 🎉

